# Driver Drowsiness Detection with CNN

This project is an end‑to‑end driver drowsiness detection system built with PyTorch and OpenCV.  
It trains a Convolutional Neural Network (CNN) to classify facial states (open eyes, closed eyes, yawning, etc.), runs real‑time detection from a webcam, and evaluates performance using standard metrics.

---

## Features

- CNN‑based classifier for 4 classes:
  - `Open`
  - `Closed`
  - `Yawn`
  - `No_Yawn`
- Real‑time detection from webcam with:
  - Face detection using Haar Cascades
  - Temporal smoothing via a **Score** counter (reduces false alarms from blinks)
  - Audio/visual drowsiness alert
- Evaluation utilities:
  - Confusion matrix
  - Precision, recall, F1‑score per class
  - Visualization as heatmap

---

## Project Structure

```text
project_root/
│
├─ train.py        # Train the CNN model on image dataset
├─ main.py         # Real‑time drowsiness detection from webcam
├─ evaluate.py     # Evaluation: confusion matrix, report, plots
│
├─ models/
│   └─ drowsiness_model.pth   # Saved model weights (generated by train.py)
│
├─ data/
│   ├─ train/
│   │   ├─ Open/
│   │   ├─ Closed/
│   │   ├─ Yawn/
│   │   └─ No_Yawn/
│   └─ test/
│       ├─ Open/
│       ├─ Closed/
│       ├─ Yawn/
│       └─ No_Yawn/
│
├─ haarcascades/
│   └─ haarcascade_frontalface_default.xml
│
└─ README.md
```

You can adjust folder names/paths in the scripts if your structure differs.

---

## Requirements

- Python 3.8+
- PyTorch
- torchvision
- OpenCV‑Python
- NumPy
- Matplotlib
- scikit‑learn

Example installation:

```bash
pip install torch torchvision torchaudio
pip install opencv-python numpy matplotlib scikit-learn
```

If you use a virtual environment, activate it before installing.

---

## 1. Training: `train.py`

`train.py` is where the CNN “student” learns from labeled images.

### What it does

- Loads images from `data/train` (and optionally `data/val`) using `ImageFolder` and `DataLoader`.
- Applies transforms:
  - Resize / crop
  - `ToTensor`
  - `Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))` (example)
- Defines `DrowsinessCNN` with:
  - Multiple `Conv2d + ReLU + MaxPool2d` layers
  - Fully connected layers
  - `Dropout` to reduce overfitting
- Trains for several epochs:
  - Forward pass → loss (CrossEntropyLoss) → backward pass → optimizer step (Adam)
- Saves best model weights to `models/drowsiness_model.pth`.

### How to run

```bash
python train.py
```

Typical arguments you might support (adjust to your implementation):

```bash
python train.py \
  --data-root data/train \
  --epochs 20 \
  --batch-size 32 \
  --lr 1e-3 \
  --save-path models/drowsiness_model.pth
```

---

## 2. Real‑Time Detection: `main.py`

`main.py` is the “job” where the trained model is used in real time with a webcam.

### Key steps

1. Load the trained model and weights:
   - `model = DrowsinessCNN(...)`
   - `model.load_state_dict(torch.load('models/drowsiness_model.pth', map_location='cpu'))`
   - `model.eval()`
2. Open a webcam stream with OpenCV.
3. Use Haar Cascade to detect face ROI:
   - Load XML: `haarcascade_frontalface_default.xml`
   - For each frame, detect faces and crop `frame[y:y+h, x:x+w]`.
4. Preprocess the crop:
   - Resize to the input size expected by the CNN
   - Convert to tensor and normalize
5. Run inference under `torch.no_grad()` and apply Softmax to get class probabilities.
6. Temporal smoothing with a `score` variable:
   - If prediction is “Closed” or “Yawn”: `score += 1`
   - Else: `score -= 1` (clamped to a minimum of 0)
   - If `score > threshold` (e.g., 15), trigger alarm (beep sound, text warning, etc.).

### How to run

```bash
python main.py
```

Common configurable options:

- Webcam index (e.g., `--camera 0`)
- Alert threshold (e.g., `--threshold 15`)
- Model path (`--model-path models/drowsiness_model.pth`)

---

## 3. Evaluation: `evaluate.py`

`evaluate.py` is the “exam” for the model on a held‑out test set.

### What it does

- Loads the trained model (`drowsiness_model.pth`).
- Loads images from `data/test` using `DataLoader`.
- Disables gradients (`torch.no_grad()`) and collects:
  - `all_preds`: predicted classes
  - `all_labels`: true classes
- Computes:
  - Classification report (precision, recall, F1, support) using `sklearn.metrics.classification_report`.
  - Confusion matrix using `sklearn.metrics.confusion_matrix`.
- Optionally plots confusion matrix heatmap with `matplotlib`.

### How to run

```bash
python evaluate.py
```

The script can print metrics to the console and/or save plots, for example:

- `results/classification_report.txt`
- `results/confusion_matrix.png`

---

## Workflow Summary

1. **Prepare data**
   - Organize images into train/test folders with subfolders:
     - `Open`, `Closed`, `Yawn`, `No_Yawn`.
2. **Train**
   - Run `train.py` to train the CNN and save `drowsiness_model.pth`.
3. **Evaluate**
   - Run `evaluate.py` to get performance metrics and confusion matrix.
4. **Deploy**
   - Run `main.py` to perform real‑time drowsiness detection from webcam and trigger alerts.

---

## Possible Extensions

- **Optimization**
  - Model pruning/quantization for Raspberry Pi.
  - Use smaller networks or convert to ONNX / TensorRT where available.
- **Refinement**
  - Combine CNN output with classical Eye Aspect Ratio (EAR) for hybrid decisions.
  - Add head pose estimation to detect nodding off.
- **Deployment**
  - Package as a desktop app (.exe) with tools like PyInstaller or Briefcase.
  - Add a simple GUI showing live video, score, and state.
